<div class="container-fluid bg-light min-vh-100 font-sans">
  <div class="row">

    <div class="col-12 col-md-3 col-xl-2 px-0 bg-white border-end sticky-md-top d-flex flex-column pt-4 pt-md-5 shadow-sm"
         style="z-index: 1000; min-height: auto; height: auto; max-height: none;">
      <div class="d-flex flex-column align-items-center w-100 px-3 text-center">
        <div class="mb-3 position-relative">
          @if (user.immagineProfilo) {
            <img [src]="user.immagineProfilo" alt="Avatar" class="rounded-circle bg-light p-1" width="90" height="90" style="object-fit: cover;">
          } @else {
            <img [src]="'https://api.dicebear.com/7.x/avataaars/svg?seed=' + (user.username || 'default')" alt="Avatar" class="rounded-circle bg-light p-1" width="90" height="90">
          }
          <div class="position-absolute bottom-0 end-0 bg-success border border-white rounded-circle p-2"></div>
        </div>
        <h5 class="fw-bold mb-0 text-dark">{{user.nome}} {{user.cognome}}</h5>
        <p class="text-muted small mb-4">&#64;{{user.username}}</p>

        <div class="w-100 text-start bg-light p-3 rounded-3 mb-4">
          <small class="text-muted fw-bold d-block mb-1" style="font-size: 0.7rem;">EMAIL</small>
          <div class="text-break small fw-medium text-dark lh-sm">{{user.email}}</div>
        </div>

        <div class="d-grid gap-2 w-100 mt-2 mb-4 px-2">

          @if (isAdmin) {
            <a routerLink="/admin/gestione" class="btn btn-primary btn-sm rounded-3 d-flex align-items-center justify-content-center gap-2 fw-bold shadow-sm mb-2">
              <span style="font-size: 1.1rem;"></span> Gestione App
            </a>
          }

          <a routerLink="/settings" class="btn btn-outline-secondary btn-sm rounded-3 d-flex align-items-center justify-content-center gap-2">Impostazioni</a>

          <button class="btn btn-danger-subtle text-danger btn-sm rounded-3 d-flex align-items-center justify-content-center gap-2"
                  (click)="logout()">
            Esci
          </button>
        </div>
      </div>
    </div>

    <div class="col-12 col-md-9 col-xl-10 py-5 px-3 px-md-4 overflow-auto">
      <div class="d-flex flex-column flex-md-row justify-content-between align-items-center mb-5 gap-3">
        <div class="text-center text-md-start">
          <h2 class="fw-bold text-dark mb-1">{{ saluto }}, {{ user.nome ? user.nome : 'Utente' }}!</h2>
          <p class="text-muted small">Ecco il riepilogo delle tue recensioni.</p>
        </div>
      </div>

      <div class="row g-5">
        <div class="col-lg-8">
          <div class="bg-white p-1 rounded-3 border mb-4 d-inline-flex mw-100 overflow-auto">
            <ul class="nav nav-pills flex-nowrap" id="pills-tab">
              <li class="nav-item"><a class="nav-link rounded-3 px-3 py-2 small fw-bold" [class.active]="activeTab === 'games'" (click)="setActiveTab('games')" href="javascript:void(0)">Games</a></li>
              <li class="nav-item"><a class="nav-link rounded-3 px-3 py-2 small fw-bold" [class.active]="activeTab === 'serie'" (click)="setActiveTab('serie')" href="javascript:void(0)">Serie TV</a></li>
              <li class="nav-item"><a class="nav-link rounded-3 px-3 py-2 small fw-bold" [class.active]="activeTab === 'film'" (click)="setActiveTab('film')" href="javascript:void(0)">Film</a></li>
            </ul>
          </div>

          <div class="fade-in mb-5">
            @if (activeTab === 'games') {
              <h6 class="fw-bold text-secondary mb-3 text-uppercase small ls-1">Recensioni Videogiochi</h6>
              <div class="row g-3">
                @for (rec of recensioniIds; track (rec.id)) {
                  @if (rec.tipo === 'GIOCO' || rec.tipo === 'GAME') {
                    <div class="col-12">
                      <div class="card border-0 shadow-sm rounded-3 p-2"
                           [class.bg-success-subtle]="rec.voto >= 7"
                           [class.bg-warning-subtle]="rec.voto >= 5 && rec.voto < 7"
                           [class.bg-danger-subtle]="rec.voto < 5">
                        <div class="card-body">
                          @if (!rec.isEditing) {
                            <div class="d-flex justify-content-between align-items-center">
                              <h6 class="fw-bold mb-1 text-truncate pe-2">{{rec.titolo}}</h6>
                              <div class="d-flex align-items-center gap-2 flex-shrink-0">
                                <button class="btn btn-sm text-primary p-0" (click)="attivaModifica(rec)">✎</button>
                                <button class="btn btn-sm p-0 fw-bold" [class.text-danger]="rec.inEliminazione" [class.text-muted]="!rec.inEliminazione" (click)="rimuoviRecensione(rec)">
                                  {{ rec.inEliminazione ? 'Elimina?' : '✕' }}
                                </button>
                                <span class="badge rounded-pill"
                                      [class.bg-success]="rec.voto >= 7"
                                      [class.bg-warning]="rec.voto >= 5 && rec.voto < 7"
                                      [class.bg-danger]="rec.voto < 5">{{rec.voto}}/10</span>
                              </div>
                            </div>
                            <p class="small text-muted mb-0 mt-2 text-break">
                              @if (rec.testo) { "{{ rec.testo }}" } @else { <span class="fst-italic opacity-50">Nessun commento inserito.</span> }
                            </p>
                          } @else {
                            <div class="row g-2">
                              <div class="col-3">
                                <input type="number" class="form-control form-control-sm" min="1" max="10" [(ngModel)]="rec.editVoto">
                              </div>
                              <div class="col-9">
                                <textarea class="form-control form-control-sm" [(ngModel)]="rec.editTesto"></textarea>
                              </div>
                              <div class="col-12 d-flex gap-2">
                                <button class="btn btn-primary btn-sm px-3" (click)="salvaModifica(rec)">Salva</button>
                                <button class="btn btn-light btn-sm px-3" (click)="annullaModifica(rec)">Annulla</button>
                              </div>
                            </div>
                          }
                        </div>
                      </div>
                    </div>
                  }
                }
              </div>
            }
            @if (activeTab === 'serie') {
              <h6 class="fw-bold text-secondary mb-3 text-uppercase small ls-1">Recensioni Serie TV</h6>
              <div class="row g-3">
                @for (rec of recensioniIds; track (rec.id)) {
                  @if (rec.tipo === 'SERIE_TV' || rec.tipo === 'SERIE TV') {
                    <div class="col-12">
                      <div class="card border-0 shadow-sm rounded-3 p-2"
                           [class.bg-success-subtle]="rec.voto >= 7"
                           [class.bg-warning-subtle]="rec.voto >= 5 && rec.voto < 7"
                           [class.bg-danger-subtle]="rec.voto < 5">
                        <div class="card-body">
                          @if (!rec.isEditing) {
                            <div class="d-flex justify-content-between align-items-center">
                              <h6 class="fw-bold mb-1 text-truncate pe-2">{{rec.titolo}}</h6>
                              <div class="d-flex align-items-center gap-2 flex-shrink-0">
                                <button class="btn btn-sm text-primary p-0" (click)="attivaModifica(rec)">✎</button>
                                <button class="btn btn-sm p-0 fw-bold" [class.text-danger]="rec.inEliminazione" [class.text-muted]="!rec.inEliminazione" (click)="rimuoviRecensione(rec)">
                                  {{ rec.inEliminazione ? 'Elimina?' : '✕' }}
                                </button>
                                <span class="badge rounded-pill"
                                      [class.bg-success]="rec.voto >= 7"
                                      [class.bg-warning]="rec.voto >= 5 && rec.voto < 7"
                                      [class.bg-danger]="rec.voto < 5">{{rec.voto}}/10</span>
                              </div>
                            </div>
                            <p class="small text-muted mb-0 mt-2 text-break">"{{ rec.testo || 'Nessun commento inserito.' }}"</p>
                          } @else {
                            <div class="row g-2">
                              <div class="col-3"><input type="number" class="form-control form-control-sm" [(ngModel)]="rec.editVoto"></div>
                              <div class="col-9"><textarea class="form-control form-control-sm" [(ngModel)]="rec.editTesto"></textarea></div>
                              <div class="col-12 d-flex gap-2">
                                <button class="btn btn-primary btn-sm px-3" (click)="salvaModifica(rec)">Salva</button>
                                <button class="btn btn-light btn-sm px-3" (click)="annullaModifica(rec)">Annulla</button>
                              </div>
                            </div>
                          }
                        </div>
                      </div>
                    </div>
                  }
                }
              </div>
            }
            @if (activeTab === 'film') {
              <h6 class="fw-bold text-secondary mb-3 text-uppercase small ls-1">Recensioni Film</h6>
              <div class="row g-3">
                @for (rec of recensioniIds; track (rec.id)) {
                  @if (rec.tipo === 'FILM') {
                    <div class="col-12">
                      <div class="card border-0 shadow-sm rounded-3 p-2"
                           [class.bg-success-subtle]="rec.voto >= 7"
                           [class.bg-warning-subtle]="rec.voto >= 5 && rec.voto < 7"
                           [class.bg-danger-subtle]="rec.voto < 5">
                        <div class="card-body">
                          @if (!rec.isEditing) {
                            <div class="d-flex justify-content-between align-items-center">
                              <h6 class="fw-bold mb-1 text-truncate pe-2">{{rec.titolo}}</h6>
                              <div class="d-flex align-items-center gap-2 flex-shrink-0">
                                <button class="btn btn-sm text-primary p-0" (click)="attivaModifica(rec)">✎</button>
                                <button class="btn btn-sm p-0 fw-bold" [class.text-danger]="rec.inEliminazione" [class.text-muted]="!rec.inEliminazione" (click)="rimuoviRecensione(rec)">
                                  {{ rec.inEliminazione ? 'Elimina?' : '✕' }}
                                </button>
                                <span class="badge rounded-pill"
                                      [class.bg-success]="rec.voto >= 7"
                                      [class.bg-warning]="rec.voto >= 5 && rec.voto < 7"
                                      [class.bg-danger]="rec.voto < 5">{{rec.voto}}/10</span>
                              </div>
                            </div>
                            <p class="small text-muted mb-0 mt-2 text-break">"{{ rec.testo || 'Nessun commento inserito.' }}"</p>
                          } @else {
                            <div class="row g-2">
                              <div class="col-3"><input type="number" class="form-control form-control-sm" [(ngModel)]="rec.editVoto"></div>
                              <div class="col-9"><textarea class="form-control form-control-sm" [(ngModel)]="rec.editTesto"></textarea></div>
                              <div class="col-12 d-flex gap-2">
                                <button class="btn btn-primary btn-sm px-3" (click)="salvaModifica(rec)">Salva</button>
                                <button class="btn btn-light btn-sm px-3" (click)="annullaModifica(rec)">Annulla</button>
                              </div>
                            </div>
                          }
                        </div>
                      </div>
                    </div>
                  }
                }
              </div>
            }
          </div>

          <hr class="border-secondary opacity-10 my-5">

          <h5 class="fw-bold text-dark mb-4">Tutte le recensioni</h5>
          @for (rec of recensioniIds; track (rec.id)) {
            <div class="card border-0 shadow-sm rounded-3 mb-3"
                 [class.bg-success-subtle]="rec.voto >= 7"
                 [class.bg-warning-subtle]="rec.voto >= 5 && rec.voto < 7"
                 [class.bg-danger-subtle]="rec.voto < 5">
              <div class="card-body p-4">
                @if (!rec.isEditing) {
                  <div class="d-flex justify-content-between align-items-start mb-2">
                    <div class="d-flex align-items-center gap-3">
                      <span class="badge rounded-3 p-2 fs-6 fw-bold"
                            [class.bg-success]="rec.voto >= 7" [class.text-white]="rec.voto >= 7"
                            [class.bg-warning]="rec.voto >= 5 && rec.voto < 7" [class.text-dark]="rec.voto >= 5 && rec.voto < 7"
                            [class.bg-danger]="rec.voto < 5" [class.text-white]="rec.voto < 5"
                            style="min-width: 60px;">{{rec.voto}}/10</span>
                      <div>
                        <h6 class="fw-bold mb-0 text-dark">{{rec.titolo}}</h6>
                        <small class="text-muted d-block" style="font-size: 0.7rem;">{{rec.tipo}}</small>
                      </div>
                    </div>
                    <div class="d-flex gap-2">
                      <button class="btn btn-sm text-primary fw-bold" (click)="attivaModifica(rec)">✎</button>
                      <button class="btn btn-sm fw-bold" [class.btn-danger]="rec.inEliminazione" [class.text-white]="rec.inEliminazione" [class.text-muted]="!rec.inEliminazione" (click)="rimuoviRecensione(rec)">
                        {{ rec.inEliminazione ? 'Elimina?' : '✕' }}
                      </button>
                    </div>
                  </div>
                  <p class="text-muted mt-2 mb-0 small text-break">
                    @if (rec.testo) { "{{ rec.testo }}" } @else { <span class="fst-italic opacity-50">Nessun commento inserito.</span> }
                  </p>
                } @else {
                  <div class="row g-3">
                    <div class="col-md-3">
                      <label class="small fw-bold text-muted mb-1">VALUTAZIONE (1-10)</label>
                      <input type="number" class="form-control bg-light border-0" min="1" max="10" [(ngModel)]="rec.editVoto">
                    </div>
                    <div class="col-12">
                      <label class="small fw-bold text-muted mb-1">COMMENTO</label>
                      <textarea class="form-control bg-light border-0" rows="3" [(ngModel)]="rec.editTesto"></textarea>
                    </div>
                    <div class="col-12 d-flex gap-2 mt-2">
                      <button class="btn btn-primary btn-sm rounded-pill px-4 fw-bold" (click)="salvaModifica(rec)">Salva</button>
                      <button class="btn btn-light btn-sm rounded-pill px-4" (click)="annullaModifica(rec)">Annulla</button>
                    </div>
                  </div>
                }
              </div>
            </div>
          }
        </div>

        <div class="col-lg-4">
          <div class="card border-0 shadow-sm rounded-4 sticky-lg-top bg-white" style="top: 20px;">
            <div class="card-body p-4">
              <h6 class="fw-bold mb-4 text-dark">Preferiti (ID)</h6>
              <div class="input-group mb-4">
                <input type="text" class="form-control bg-light border-0 py-2 small" placeholder="Cerca ID..." [(ngModel)]="searchText">
              </div>
              <div class="d-flex flex-column gap-2" style="max-height: 400px; overflow-y: auto;">
                @for (id of preferitiIds; track id) {
                  <div class="d-flex align-items-center justify-content-between p-2 rounded-3 border-bottom border-light">
                    <div class="d-flex align-items-center gap-3 overflow-hidden">
                      <div class="rounded-circle bg-primary flex-shrink-0" style="width: 8px; height: 8px;"></div>
                      <div class="d-flex flex-column text-truncate">
                        <span class="fw-bold text-dark small text-truncate">{{ id.titolo || id.contenuto?.titolo || ('Media ID: ' + id.id) }}</span>
                        <span class="text-muted" style="font-size: 0.7rem;">Preferito</span>
                      </div>
                    </div>

                    <button class="btn btn-sm fw-bold px-2 transition-all"
                            [class.btn-danger]="id.inEliminazione"
                            [class.text-white]="id.inEliminazione"
                            [class.text-secondary]="!id.inEliminazione"
                            (click)="rimuoviPreferito(id)"
                            style="min-width: 30px;">
                      {{ id.inEliminazione ? 'Elimina?' : '✕' }}
                    </button>

                  </div>
                }
              </div>
            </div>
          </div>
        </div>

      </div>
    </div>
  </div>
</div>
