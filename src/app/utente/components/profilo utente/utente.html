<div class="container-fluid bg-light min-vh-100 font-sans">
  <div class="row flex-nowrap">

    <div class="col-auto col-md-3 col-xl-2 px-0 bg-white border-end vh-100 sticky-top d-flex flex-column pt-5 shadow-sm" style="z-index: 1000;">
      <div class="d-flex flex-column align-items-center w-100 px-3 text-center">
        <div class="mb-3 position-relative">
          @if (user.immagineProfilo) {
            <img [src]="user.immagineProfilo" alt="Avatar" class="rounded-circle bg-light p-1" width="90" height="90" style="object-fit: cover;">
          } @else {
            <img [src]="'https://api.dicebear.com/7.x/avataaars/svg?seed=' + (user.username || 'default')" alt="Avatar" class="rounded-circle bg-light p-1" width="90" height="90">
          }
          <div class="position-absolute bottom-0 end-0 bg-success border border-white rounded-circle p-2"></div>
        </div>
        <h5 class="fw-bold mb-0 text-dark">{{user.nome}} {{user.cognome}}</h5>
        <p class="text-muted small mb-4">&#64;{{user.username}}</p>
        <div class="w-100 text-start bg-light p-3 rounded-3 mb-4">
          <small class="text-muted fw-bold d-block mb-1" style="font-size: 0.7rem;">EMAIL</small>
          <div class="text-break small fw-medium text-dark lh-sm">{{user.email}}</div>
        </div>
        <div class="d-grid gap-2 w-100 mt-auto mb-4 px-2">
          <a routerLink="/settings" class="btn btn-outline-secondary btn-sm rounded-3 d-flex align-items-center justify-content-center gap-2">Impostazioni</a>
          <button class="btn btn-danger-subtle text-danger btn-sm rounded-3 d-flex align-items-center justify-content-center gap-2">Esci</button>
        </div>
      </div>
    </div>

    <div class="col py-5 px-4 overflow-auto h-100">
      <div class="d-flex justify-content-between align-items-center mb-5">
        <div>
          <h2 class="fw-bold text-dark mb-1">{{ saluto }}, {{ user.nome ? user.nome : 'Utente' }}!</h2>
          <p class="text-muted small">Ecco il riepilogo delle tue recensioni.</p>
        </div>
      </div>

      <div class="row g-5">
        <div class="col-lg-8">
          <div class="bg-white p-1 rounded-3 border mb-4 d-inline-flex">
            <ul class="nav nav-pills" id="pills-tab">
              <li class="nav-item"><a class="nav-link rounded-3 px-3 py-2 small fw-bold" [class.active]="activeTab === 'games'" (click)="setActiveTab('games')" href="javascript:void(0)">Games</a></li>
              <li class="nav-item"><a class="nav-link rounded-3 px-3 py-2 small fw-bold" [class.active]="activeTab === 'serie'" (click)="setActiveTab('serie')" href="javascript:void(0)">Serie TV</a></li>
              <li class="nav-item"><a class="nav-link rounded-3 px-3 py-2 small fw-bold" [class.active]="activeTab === 'film'" (click)="setActiveTab('film')" href="javascript:void(0)">Film</a></li>
            </ul>
          </div>

          <div class="fade-in mb-5">
            @if (activeTab === 'games') {
              <h6 class="fw-bold text-secondary mb-3 text-uppercase small ls-1">Recensioni Videogiochi</h6>
              <div class="row g-3">
                @for (rec of recensioniIds; track rec) {
                  @if (rec.contenuto?.tipo === 'GIOCO' || rec.contenuto?.tipo === 'Game' || rec.categoria === 'Games') {
                    <div class="col-12">
                      <div class="card border-0 shadow-sm rounded-3 p-2">
                        <div class="card-body">
                          <div class="d-flex justify-content-between align-items-center">
                            <h6 class="fw-bold mb-1">{{rec.titolo || rec.contenuto?.titolo || rec.oggetto}}</h6>
                            <span class="badge bg-success-subtle text-success rounded-pill">{{rec.voto}}/10</span>
                          </div>
                          <p class="small text-muted mb-0 mt-2">
                            @if (rec.testo || rec.descrizione) { "{{ rec.testo || rec.descrizione }}" } @else { <span class="fst-italic opacity-50">Nessun commento inserito.</span> }
                          </p>
                        </div>
                      </div>
                    </div>
                  }
                }
                @if (recensioniIds.length === 0) { <p class="text-muted small">Nessuna recensione trovata.</p> }
              </div>
            }

            @if (activeTab === 'serie') {
              <h6 class="fw-bold text-secondary mb-3 text-uppercase small ls-1">Recensioni Serie TV</h6>
              <div class="row g-3">
                @for (rec of recensioniIds; track rec) {
                  @if (rec.contenuto?.tipo === 'SERIE_TV' || rec.contenuto?.tipo === 'Serie TV' || rec.categoria === 'Serie TV') {
                    <div class="col-12">
                      <div class="card border-0 shadow-sm rounded-3 p-2">
                        <div class="card-body">
                          <div class="d-flex justify-content-between align-items-center">
                            <h6 class="fw-bold mb-1">{{rec.titolo || rec.contenuto?.titolo || rec.oggetto}}</h6>
                            <span class="badge bg-danger-subtle text-danger rounded-pill">{{rec.voto}}/10</span>
                          </div>
                          <p class="small text-muted mb-0 mt-2">
                            @if (rec.testo || rec.descrizione) { "{{ rec.testo || rec.descrizione }}" } @else { <span class="fst-italic opacity-50">Nessun commento inserito.</span> }
                          </p>
                        </div>
                      </div>
                    </div>
                  }
                }
              </div>
            }

            @if (activeTab === 'film') {
              <h6 class="fw-bold text-secondary mb-3 text-uppercase small ls-1">Recensioni Film</h6>
              <div class="row g-3">
                @for (rec of recensioniIds; track rec) {
                  @if (rec.contenuto?.tipo === 'FILM' || rec.contenuto?.tipo === 'Film' || rec.categoria === 'Film') {
                    <div class="col-12">
                      <div class="card border-0 shadow-sm rounded-3 p-2">
                        <div class="card-body">
                          <div class="d-flex justify-content-between align-items-center">
                            <h6 class="fw-bold mb-1">{{rec.titolo || rec.contenuto?.titolo || rec.oggetto}}</h6>
                            <span class="badge bg-primary-subtle text-primary rounded-pill">{{rec.voto}}/10</span>
                          </div>
                          <p class="small text-muted mb-0 mt-2">
                            @if (rec.testo || rec.descrizione) { "{{ rec.testo || rec.descrizione }}" } @else { <span class="fst-italic opacity-50">Nessun commento inserito.</span> }
                          </p>
                        </div>
                      </div>
                    </div>
                  }
                }
              </div>
            }
          </div>

          <hr class="border-secondary opacity-10 my-5">

          <h5 class="fw-bold text-dark mb-4">Tutte le recensioni</h5>
          @for (rec of recensioniIds; track rec) {
            <div class="card border-0 shadow-sm rounded-3 mb-3 bg-white">
              <div class="card-body p-4">
                <div class="d-flex justify-content-between align-items-start mb-2">
                  <div class="d-flex align-items-center gap-3">
                    @if (rec.voto >= 7) {
                      <span class="badge bg-success-subtle text-success border border-success-subtle rounded-3 p-2 fs-6 fw-bold" style="min-width: 60px;">{{rec.voto}}/10</span>
                    } @else if (rec.voto >= 5) {
                      <span class="badge bg-warning-subtle text-warning-emphasis border border-warning-subtle rounded-3 p-2 fs-6 fw-bold" style="min-width: 60px;">{{rec.voto}}/10</span>
                    } @else {
                      <span class="badge bg-danger-subtle text-danger border border-danger-subtle rounded-3 p-2 fs-6 fw-bold" style="min-width: 60px;">{{rec.voto}}/10</span>
                    }
                    <div>
                      <h6 class="fw-bold mb-0 text-dark">{{rec.titolo || rec.contenuto?.titolo || rec.oggetto}}</h6>
                      <small class="text-muted d-block" style="font-size: 0.7rem;">{{rec.contenuto?.tipo || rec.categoria}}</small>
                    </div>
                  </div>

                  @if (!rec.inEliminazione) {
                    <button class="btn btn-sm text-muted hover-danger" (click)="rimuoviRecensione(rec)">✕</button>
                  } @else {
                    <button class="btn btn-danger btn-sm py-0 px-2 fw-bold" (click)="rimuoviRecensione(rec)" style="font-size: 0.7rem;">Elimina?</button>
                  }

                </div>
                <p class="text-muted mt-2 mb-0 small">
                  @if (rec.testo || rec.descrizione) { "{{ rec.testo || rec.descrizione }}" } @else { <span class="fst-italic opacity-50">Nessun commento inserito.</span> }
                </p>
              </div>
            </div>
          }
          @if (recensioniIds.length === 0) {
            <div class="text-center py-4 text-muted">Non hai ancora scritto recensioni o non sono state caricate dal server.</div>
          }
        </div>

        <div class="col-lg-4">
          <div class="card border-0 shadow-sm rounded-4 sticky-top bg-white" style="top: 20px;">
            <div class="card-body p-4">
              <h6 class="fw-bold mb-4 text-dark">Preferiti (ID)</h6>
              <div class="input-group mb-4">
                <input type="text" class="form-control bg-light border-0 py-2 small" placeholder="Cerca ID..." [(ngModel)]="searchText">
              </div>
              <div class="d-flex flex-column gap-2">
                @for (id of preferitiIds; track id) {
                  <div class="d-flex align-items-center justify-content-between p-2 rounded-3 border-bottom border-light">
                    <div class="d-flex align-items-center gap-3">
                      <div class="rounded-circle bg-primary d-flex align-items-center justify-content-center" style="width: 8px; height: 8px;"></div>
                      <div class="d-flex flex-column">
                        <span class="fw-bold text-dark small">{{ id.titolo || id.contenuto?.titolo || ('Media ID: ' + id.id) }}</span>
                        <span class="text-muted" style="font-size: 0.7rem;">Preferito</span>
                      </div>
                    </div>

                    @if (!id.inEliminazione) {
                      <button class="btn btn-sm text-secondary p-0 ms-1 small" (click)="rimuoviPreferito(id)">✕</button>
                    } @else {
                      <button class="btn btn-danger btn-sm py-0 px-2 fw-bold" (click)="rimuoviPreferito(id)" style="font-size: 0.6rem;">Elimina?</button>
                    }

                  </div>
                }
                @if (preferitiIds.length === 0) { <p class="text-muted small text-center">Nessun preferito trovato.</p> }
              </div>
            </div>
          </div>
        </div>

      </div>
    </div>
  </div>
</div>
