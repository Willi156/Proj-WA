<div class="page" *ngIf="!loading; else loadingTpl">
  <div class="wrap" *ngIf="content; else errorTpl">

    <!-- SX: COPERTINA -->
    <aside class="left">
      <img class="cover" [src]="content.cover" [alt]="content.title" />
    </aside>

    <!-- DX: INFO -->
    <main class="right">
      <header class="head">

        <!-- SCORE FLOATING -->
        <div class="ratingBadge" *ngIf="content.rating !== undefined">
          <span class="ratingValue">{{ content.rating }}</span>
          <span class="ratingMax">/10</span>
        </div>

        <h1 class="title">{{ content.title }}</h1>

        <div class="meta">
          <div class="chip">
            <span class="label">Anno</span>
            <span class="value">{{ content.year }}</span>
          </div>

          <div class="chip">
            <span class="label">Genere</span>
            <span class="value">{{ content.genre }}</span>
          </div>
        </div>

        <!-- DOVE vederlo / comprarlo -->
        <div class="whereBox">
          <span class="whereLabel">
            {{ kind === 'GAME' ? 'Compra ora' : 'Guarda ora' }}
          </span>

          <div class="whereButtons">
            <span class="whereBtn" *ngIf="kind === 'GAME'">PlayStation</span>
            <span class="whereBtn" *ngIf="kind === 'GAME'">Xbox</span>
            <span class="whereBtn" *ngIf="kind === 'GAME'">Steam</span>
          </div>
        </div>

        <p class="desc">{{ content.description }}</p>

        <!-- SOLO SE SERIE -->
        <div class="seasonRow" *ngIf="kind === 'SERIES'">
          <label class="seasonLabel" for="seasonSelect">Stagione</label>
          <select
            id="seasonSelect"
            class="seasonSelect"
            [(ngModel)]="selectedSeasonId"
            (change)="onSeasonChange()"
          >
            <option *ngFor="let s of seasons" [value]="s.id">{{ s.name }}</option>
          </select>
        </div>
      </header>
    </main>
  </div>

  <!-- RIGA 2: ACCORDIONS FULL-WIDTH -->
  <div class="fullRow" *ngIf="content">
    <section class="accordions">

      <!-- TRAILER -->
      <details class="acc" [open]="openSection === 'trailer'" (toggle)="onToggle('trailer', $event)">
        <summary class="accSum">
          <span>Trailer</span>
          <span class="chev">▾</span>
        </summary>

        <div class="accBody">
          <div class="videoWrap" *ngIf="trailerEmbed">
            <iframe
              class="video"
              [src]="trailerEmbed"
              title="Trailer"
              frameborder="0"
              allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
              allowfullscreen
            ></iframe>
          </div>
          <p class="muted" *ngIf="!trailerEmbed">Trailer non disponibile.</p>
        </div>
      </details>

      <!-- LASCIA RECENSIONE -->
      <details class="acc" [open]="openSection === 'write'" (toggle)="onToggle('write', $event)">
        <summary class="accSum">
          <span>Lascia una recensione</span>
          <span class="chev">▾</span>
        </summary>

        <div class="accBody">
          <form class="reviewForm" (ngSubmit)="submitReview()" #f="ngForm">

            <!-- VOTO A STELLE (1..10) -->
            <div class="field">
              <div class="ratingPicker" role="radiogroup" aria-label="Seleziona un voto da 1 a 10">
              <p class="label-rev">Add my score: </p>
                <button
                  type="button"
                  class="pickStar"
                  *ngFor="let _ of stars; let i = index"
                  [class.filled]="i < reviewDraft.rating"
                  (click)="setRating(i + 1)"
                  [attr.aria-checked]="(i + 1) === reviewDraft.rating"
                  role="radio"
                >
                  ★
                </button>

                <span class="ratingText">{{ reviewDraft.rating }}/10</span>
              </div>

              <!-- hidden required per form validity -->
              <input type="hidden" name="rating" [(ngModel)]="reviewDraft.rating" required />
            </div>

            <!-- TESTO RECENSIONE -->
            <div class="field">
              <textarea
                name="comment"
                [(ngModel)]="reviewDraft.comment"
                required
                rows="4"
                placeholder="Write your review here..."
              ></textarea>
            </div>

            <div class="actions">
              <button type="submit" class="btn" [disabled]="f.invalid">Pubblica</button>
              <button type="button" class="btn ghost" (click)="resetDraft()">Annulla</button>
            </div>
          </form>
        </div>
      </details>

      <!-- MOSTRA RECENSIONI -->
      <details class="acc" [open]="openSection === 'list'" (toggle)="onToggle('list', $event)">
        <summary class="accSum">
          <span>Mostra recensioni ({{ reviews.length }})</span>
          <span class="chev">▾</span>
        </summary>

        <div class="accBody">
          <ng-container *ngIf="reviews.length; else noReviews">
            <div class="reviews">
              <article class="rev" *ngFor="let r of reviews">
                <div class="revTop">
                  <strong class="revAuthor">{{ r.user }}</strong>

                  <!-- STELLE SU 10 -->
                  <span class="revScore stars" aria-label="Voto {{ r.rating }} su 10">
                    <span
                      class="star"
                      *ngFor="let _ of stars; let i = index"
                      [class.filled]="i < roundedRating(r.rating)"
                    >★</span>
                  </span>
                </div>

                <p class="revText">{{ r.comment }}</p>
                <span class="revDate muted">{{ r.date }}</span>
              </article>
            </div>
          </ng-container>

          <ng-template #noReviews>
            <p class="muted">Ancora nessuna recensione.</p>
          </ng-template>
        </div>
      </details>

    </section>
  </div>
</div>

<ng-template #loadingTpl>
  <div class="centerState">Caricamento...</div>
</ng-template>

<ng-template #errorTpl>
  <div class="centerState">
    <p class="err">{{ error || 'Contenuto non trovato.' }}</p>
  </div>
</ng-template>
